# Provability Fabric Testbed - Agent-Zoo Gateway Makefile

.PHONY: help build test test-coverage clean install dev start validate-gate lint

# Default target
help:
	@echo "Provability Fabric Testbed - Agent-Zoo Gateway"
	@echo "=============================================="
	@echo ""
	@echo "Available targets:"
	@echo "  help           - Show this help message"
	@echo "  install        - Install dependencies"
	@echo "  build          - Build TypeScript to JavaScript"
	@echo "  dev            - Start in development mode"
	@echo "  start          - Start in production mode"
	@echo "  test           - Run all tests"
	@echo "  test-coverage  - Run tests with coverage"
	@echo "  validate-gate  - Run gate validation (TB-AGENTS)"
	@echo "  lint           - Run ESLint"
	@echo "  clean          - Clean build artifacts"
	@echo ""

# Install dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	npm install

# Build TypeScript
build: install
	@echo "ğŸ”¨ Building TypeScript..."
	npm run build

# Start in development mode
dev: install
	@echo "ğŸš€ Starting in development mode..."
	npm run dev

# Start in production mode
start: build
	@echo "ğŸš€ Starting in production mode..."
	npm start

# Run all tests
test: install
	@echo "ğŸ§ª Running tests..."
	npm test

# Run tests with coverage
test-coverage: install
	@echo "ğŸ“Š Running tests with coverage..."
	npm run test:coverage

# Run gate validation (TB-AGENTS)
validate-gate: install
	@echo "ğŸšª Running Agent-Zoo Gate Validation (TB-AGENTS)..."
	@echo "This validates that all five journeys run on all four stacks with comparable metrics."
	@echo ""
	npx ts-node scripts/validate-gate.ts

# Run ESLint
lint: install
	@echo "ğŸ” Running ESLint..."
	npm run lint

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf dist/
	rm -rf node_modules/
	rm -rf coverage/
	@echo "âœ… Clean complete"

# Quick validation (build + test + gate validation)
validate: build test validate-gate
	@echo "ğŸ‰ All validations passed!"

# Development workflow
dev-setup: install build test
	@echo "âœ… Development environment setup complete"

# Production deployment
deploy: clean install build test validate-gate
	@echo "ğŸš€ Production deployment ready"

# Show status
status:
	@echo "ğŸ“Š Gateway Status:"
	@echo "  Node version: $(shell node --version)"
	@echo "  NPM version: $(shell npm --version)"
	@echo "  TypeScript version: $(shell npx tsc --version)"
	@if [ -d "node_modules" ]; then echo "  Dependencies: âœ… Installed"; else echo "  Dependencies: âŒ Not installed"; fi
	@if [ -d "dist" ]; then echo "  Build: âœ… Built"; else echo "  Build: âŒ Not built"; fi
	@if [ -f "package-lock.json" ]; then echo "  Lock file: âœ… Present"; else echo "  Lock file: âŒ Missing"; fi

# Health check
health:
	@echo "ğŸ¥ Health Check:"
	@if [ -f "dist/main.js" ]; then echo "  Main executable: âœ… Present"; else echo "  Main executable: âŒ Missing"; fi
	@if [ -f "src/main.ts" ]; then echo "  Source files: âœ… Present"; else echo "  Source files: âŒ Missing"; fi
	@if [ -f "env.example" ]; then echo "  Environment template: âœ… Present"; else echo "  Environment template: âŒ Missing"; fi
	@if [ -f "tsconfig.json" ]; then echo "  TypeScript config: âœ… Present"; else echo "  TypeScript config: âŒ Missing"; fi

# Environment setup
env-setup:
	@echo "âš™ï¸  Environment Setup:"
	@if [ ! -f ".env" ]; then \
		echo "  Creating .env from template..."; \
		cp env.example .env; \
		echo "  âœ… .env created from template"; \
		echo "  âš ï¸  Please configure your API keys and settings in .env"; \
	else \
		echo "  .env: âœ… Already exists"; \
	fi

# Security check
security-check:
	@echo "ğŸ”’ Security Check:"
	@if [ -f ".env" ]; then \
		echo "  .env file: âœ… Present (check for sensitive data)"; \
	else \
		echo "  .env file: âŒ Missing (run 'make env-setup')"; \
	fi
	@if [ -f "package-lock.json" ]; then echo "  Package lock: âœ… Present"; else echo "  Package lock: âŒ Missing"; fi
	@echo "  âš ï¸  Review dependencies for security vulnerabilities: npm audit"

# Performance test
perf-test: install
	@echo "âš¡ Performance Testing:"
	@echo "  Running performance benchmarks..."
	npm run test:perf || echo "  âš ï¸  Performance tests not configured"

# Documentation
docs:
	@echo "ğŸ“š Documentation:"
	@if [ -f "README.md" ]; then echo "  README: âœ… Present"; else echo "  README: âŒ Missing"; fi
	@if [ -f "docs/" ]; then echo "  Docs directory: âœ… Present"; else echo "  Docs directory: âŒ Missing"; fi

# Full system check
system-check: status health env-setup security-check docs
	@echo ""
	@echo "ğŸ¯ System Check Complete!"
	@echo "  Run 'make validate-gate' to test the Agent-Zoo implementation"
	@echo "  Run 'make dev' to start the gateway in development mode"

# Show supported journeys and tools
info:
	@echo "ğŸ“‹ Agent-Zoo Information:"
	@echo ""
	@echo "Supported Agent Stacks:"
	@echo "  â€¢ OpenAI Assistants"
	@echo "  â€¢ LangChain"
	@echo "  â€¢ LangGraph"
	@echo "  â€¢ DSPy"
	@echo ""
	@echo "Supported Journeys:"
	@echo "  â€¢ support_triage"
	@echo "  â€¢ expense_approval"
	@echo "  â€¢ sales_outreach"
	@echo "  â€¢ hr_onboarding"
	@echo "  â€¢ dev_triage"
	@echo ""
	@echo "Supported Tools:"
	@echo "  â€¢ slack, email, calendar, notion"
	@echo "  â€¢ stripe, github, search, fetch"
	@echo ""
	@echo "Gate Requirements (TB-AGENTS):"
	@echo "  âœ… All five journeys run on all four stacks"
	@echo "  âœ… Normalized trace export schema"
	@echo "  âœ… Toggle shadow vs enforce (PF_ENFORCE=true)"
	@echo "  âœ… Comparable metrics across all stacks"

# Show this help by default
.DEFAULT_GOAL := help
